<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Time Slot Builder</title>

  <style>
    /*
    body { font-family: Arial, sans-serif; padding: 30px; }
    .days-container { display: flex; gap: 15px; align-items: flex-start; }
    .day-box { border: 1px solid #ccc; padding: 10px; width: 140px; }
    .day-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 8px; }
    .add-btn { cursor: pointer; }
    .slot { background: #f0f0f0; padding: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; }
    .edit-btn { font-size: 12px; cursor: pointer; }
    .slot-form { background: #fafafa; padding: 6px; border: 1px solid #ddd; margin-bottom: 6px; }
    .time-row { display: flex; gap: 5px; margin-bottom: 5px; }
    .form-actions { display: flex; justify-content: space-between; }
    .log-btn { margin-top: 25px; padding: 8px 14px; }*/
    :root {
      /* Consistent Dark Theme Palette */
      --bg-body: #0f172a;
      --bg-card: #1e293b;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border: #334155;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.1);
      --danger: #f43f5e;
      --success: #10b981;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
      --radius: 12px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      line-height: 1.5;
      padding: 40px;
      min-height: 100vh;
    }

    /* Header Navigation */
    .nav-header {
      width: 100%;
      margin-bottom: 30px;
    }

    .back-link {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.2s;
    }

    .back-link:hover { color: var(--accent); }

    h2 {
      margin-bottom: 25px;
      font-size: 1.5rem;
      font-weight: 700;
    }

    /* Days Container Styling */
    .days-container {
      display: flex;
      gap: 15px;
      align-items: flex-start;
      overflow-x: auto; /* For mobile scroll */
      padding-bottom: 20px;
    }

    .day-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      min-width: 160px;
      box-shadow: var(--shadow);
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
      color: var(--accent);
    }

    .add-btn {
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid var(--accent);
      border-radius: 4px;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      transition: all 0.2s;
    }

    .add-btn:hover {
      background: var(--accent);
      color: var(--bg-body);
    }

    /* Individual Slot Styling */
    .slot {
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 10px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: var(--text-main);
    }

    .edit-btn {
      font-size: 0.75rem;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 2px 6px;
      border-radius: 4px;
      cursor: pointer;
    }

    .edit-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Slot Form Styling */
    .slot-form {
      background: var(--bg-body);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--accent);
      margin-bottom: 12px;
    }

    .time-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 10px;
    }

    .time-row span {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .time-row input {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 6px;
      border-radius: 4px;
      outline: none;
    }

    .form-actions {
      display: flex;
      gap: 5px;
    }

    .save-slot, .cancel-slot {
      flex: 1;
      padding: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 4px;
      cursor: pointer;
      border: none;
    }

    .save-slot { background: var(--success); color: white; }
    .cancel-slot { background: var(--border); color: var(--text-main); }

    /* Bottom Action Button */
    .log-btn {
      margin-top: 30px;
      padding: 12px 24px;
      background: var(--accent);
      color: var(--bg-body);
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: var(--shadow);
    }

    .log-btn:hover { opacity: 0.9; }

    /* Header Section */
.heading-div {
    text-align: center;
    margin-bottom: 40px;
}

.heading-div p:first-child {
    font-size: 2.5rem;
    font-weight: 800;
    letter-spacing: -1px;
    color: var(--accent);
}

.heading-div p:last-child {
    color: var(--text-muted);
    font-size: 1.1rem;
}
        /* Loader */
        #loader {
            width: 50px;
            height: 50px;
            background: radial-gradient(farthest-side, #38bdf8 94%, #0000) top/4px 4px no-repeat,
                        conic-gradient(#0000 30%, #38bdf8);
            -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 4px), #000 0);
            border-radius: 50%;
            filter: drop-shadow(0 0 8px rgba(56, 189, 248, 0.6));
            animation: spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            position: fixed;
            inset: 0;
            margin: auto;
            z-index: 9999;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>

<body>
    <div id="loader"></div>

  <div id="app" style="display:none;">

              <div class="heading-div">
       <p> BookBack </p>
       <p> Patients come back. Automatically.</p>
    </div>

    
<p style="font-size: 25px;
margin-bottom: 10px;">Time Slots</p>

<div class="days-container">
  <div class="day-box" data-day="mon"><div class="day-header">Mon <button class="add-btn">+</button></div><div class="slots"></div></div>
  <div class="day-box" data-day="tue"><div class="day-header">Tue <button class="add-btn">+</button></div><div class="slots"></div></div>
  <div class="day-box" data-day="wed"><div class="day-header">Wed <button class="add-btn">+</button></div><div class="slots"></div></div>
  <div class="day-box" data-day="thu"><div class="day-header">Thu <button class="add-btn">+</button></div><div class="slots"></div></div>
  <div class="day-box" data-day="fri"><div class="day-header">Fri <button class="add-btn">+</button></div><div class="slots"></div></div>
  <div class="day-box" data-day="sat"><div class="day-header">Sat <button class="add-btn">+</button></div><div class="slots"></div></div>
  <div class="day-box" data-day="sun"><div class="day-header">Sun <button class="add-btn">+</button></div><div class="slots"></div></div>
</div>

<button class="log-btn">Save</button>
</div>
<script>
const loader = document.getElementById("loader");
const app = document.getElementById("app");

const API_BASE_URL = "https://bookback-t83d.onrender.com";

let availability = [
  { mon: [] }, { tue: [] }, { wed: [] },
  { thu: [] }, { fri: [] }, { sat: [] }, { sun: [] }
];

document.addEventListener("DOMContentLoaded", async () => {
loader.style.display = "block";
app.style.display = "none";
          let check = await fetch(`${API_BASE_URL}/refresh`,{
        method: "POST",
        credentials:"include"
        
        })

        let data2 = await check.json();

        if (!check.ok || check.status === 400){
            window.location.href = "/index.html"
            return;
        }

        if (data2.status === false){
          window.location.href = "/payment_page.html";
          return;
        }

  try {
    const res = await fetch(`${API_BASE_URL}/get-clinic-slots`, {
      method: "POST",
      credentials: "include"
    });

    if (!res.ok) {
      console.error("Failed to fetch clinic slots");
      return;
    }

    const data = await res.json();
    const clinicSlots = data.clinic_slots;

    availability = clinicSlots === null
      ? availability
      : JSON.parse(clinicSlots);
      renderAllSlots();

    console.log("Final availability:", availability);

  } catch (err) {
    console.error("Request error:", err);
  }

  loader.style.display = "none";
app.style.display = "block";

});


const getDayObj = day => availability.find(o => o[day]);

function createForm(dayBox, dayKey, slotDiv = null) {
  const form = document.createElement("div");
  form.classList.add("slot-form");

  let start = "", end = "";
  if (slotDiv) {
    [start, end] = slotDiv.dataset.value.split("-");
  }

  form.innerHTML = `
    <div class="time-row">
      <span>From</span>
      <input type="time" class="start-time" value="${start}">
    </div>
    <div class="time-row">
      <span>To</span>
      <input type="time" class="end-time" value="${end}">
    </div>
    <div class="form-actions">
      <button class="save-slot">Save</button>
      <button class="cancel-slot">Cancel</button>
    </div>
  `;

  dayBox.insertBefore(form, dayBox.querySelector(".slots"));

  form.querySelector(".save-slot").addEventListener("click",async() => {
    const s = form.querySelector(".start-time").value;
    const e = form.querySelector(".end-time").value;

    if (!s || !e) return alert("Fill both times");
    if (e <= s) return alert("End must be after start");

    const newVal = `${s}-${e}`;
    const arr = getDayObj(dayKey)[dayKey];

    if (slotDiv) {
      const idx = arr.indexOf(slotDiv.dataset.value);
      arr[idx] = newVal;

      slotDiv.dataset.value = newVal;
      slotDiv.querySelector(".slot-text").innerText = newVal;
      slotDiv.style.display = "flex";
    } else {
      arr.push(newVal);
      renderSlot(dayBox, dayKey, newVal);
    }

    form.remove();

    await saveAvailabilityToDB();
  });

  form.querySelector(".cancel-slot").addEventListener("click", () => {
    if (slotDiv) slotDiv.style.display = "flex";
    form.remove();
  });
}

async function saveAvailabilityToDB() {
  try {
    const res = await fetch(`${API_BASE_URL}/save-clinic-slots`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(availability)
    });

    if (!res.ok) {
      console.error("DB save failed:", res.status);
      return;
    }

    console.log("Availability synced to DB");
  } catch (err) {
    console.error("Save error:", err);
  }
}


function renderSlot(dayBox, dayKey, value) {
  const slot = document.createElement("div");
  slot.classList.add("slot");
  slot.dataset.value = value;

  slot.innerHTML = `
    <span class="slot-text">${value}</span>
    <button class="edit-btn">Edit</button>
  `;

  slot.querySelector(".edit-btn").addEventListener("click", () => {
    slot.style.display = "none";
    createForm(dayBox, dayKey, slot);
  });

  dayBox.querySelector(".slots").appendChild(slot);
}

function renderAllSlots() {
  // Clear all slot containers
  document.querySelectorAll(".day-box .slots").forEach(slotsDiv => {
    slotsDiv.innerHTML = "";
  });

  // Loop through availability and render
  availability.forEach(dayObj => {
    const dayKey = Object.keys(dayObj)[0];
    const slots = dayObj[dayKey];

    const dayBox = document.querySelector(
      `.day-box[data-day="${dayKey}"]`
    );

    slots.forEach(slotValue => {
      renderSlot(dayBox, dayKey, slotValue);
    });
  });
}


document.querySelectorAll(".add-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const dayBox = btn.closest(".day-box");
    const dayKey = dayBox.dataset.day;
    if (!dayBox.querySelector(".slot-form")) createForm(dayBox, dayKey);
  });
});

document.querySelector(".log-btn").addEventListener("click", async () => {
  const res = await fetch(`${API_BASE_URL}/save-clinic-slots`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify(availability)
  });

  if (!res.ok) {
    console.error("Save failed:", res.status);
    return;
  }
  if(res.ok){
    alert("Slots saved successfully !")
  }


});
</script>
</body>
</html>