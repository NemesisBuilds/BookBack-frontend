<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>BookBack â€“ Patients</title>

  <style>/*
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background: #f5f5f5;
    }

    h2 {
      margin-bottom: 15px;
    }

    .add-btn {
      margin-bottom: 15px;
      padding: 8px 14px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #eee;
    }

    input {
      width: 95%;
      padding: 5px;
    }

    button {
      padding: 5px 10px;
      cursor: pointer;
    }

    .delete-btn {
      background: #e74c3c;
      color: white;
      border: none;
    }

    .save-btn {
      background: #2ecc71;
      color: white;
      border: none;
    }

    .clinic-profile-div {
      background-color: grey;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0px 0px 5px grey;
      display: inline-block;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-box {
      background: white;
      padding: 20px;
      width: 300px;
      border-radius: 6px;
      text-align: center;
    }

    .modal-actions {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }*/
    :root {
      --bg-body: #0f172a;
      --bg-card: #1e293b;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border: #334155;
      --accent: #38bdf8;
      --danger: #f43f5e;
      --success: #10b981;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
      --radius: 12px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      line-height: 1.5;
      padding: 40px; /* Uniform padding on all sides */
      display: block; /* Removed flex center alignment */
      min-height: 100vh;
    }

    /* Top Container strictly left-aligned */
    .top-container {
      width: 100%;
      max-width: 1000px;
      display: flex;
      justify-content: space-between; 
      align-items: center;
      margin-bottom: 30px;
      margin-left: 0; /* Ensures no centering */
    }

    .clinic-profile-div {
      background: var(--bg-card);
      padding: 12px 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      display: inline-block; /* Only takes up necessary space */
      margin-bottom: 10px;
    }

    .clinic-name {
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--accent);
    }

    .clinic-email {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Page Header strictly left-aligned */
    .page-header {
      width: 100%;
      max-width: 1000px;
      margin-bottom: 20px;
      text-align: left; /* Forces text left */
    }

    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .add-btn {
      background: var(--accent);
      color: var(--bg-body);
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
      display: block; /* Ensures it sits on its own line if needed, or inline-block */
    }

    .add-btn:hover {
      opacity: 0.9;
    }

    /* Table Container stays centered relative to its max-width but aligns left */
    .table-container {
      width: 100%;
      max-width: 1000px;
      background: var(--bg-card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      overflow: hidden;
      box-shadow: var(--shadow);
      margin-left: 0; /* Ensures no centering */
    }

    table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
    }

    th {
      background: rgba(15, 23, 42, 0.5);
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
      color: var(--text-main);
    }

    tr:last-child td {
      border-bottom: none;
    }

    input {
      width: 100%;
      padding: 8px 12px;
      background: var(--bg-body);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-main);
      font-size: 0.85rem;
    }

    .delete-btn {
      background: transparent;
      color: var(--danger);
      border: 1px solid var(--danger);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
    }

    .save-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(2, 6, 23, 0.85);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-box {
      background: var(--bg-card);
      padding: 30px;
      width: 100%;
      max-width: 350px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      text-align: center;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .cancel-btn, .confirm-btn {
      flex: 1;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      font-weight: 600;
    }

    .cancel-btn { background: var(--border); color: var(--text-main); }
    .confirm-btn { background: var(--danger); color: white; }
    /* Header Section */
.heading-div {
    text-align: center;
    margin-bottom: 40px;
}

.heading-div p:first-child {
    font-size: 2.5rem;
    font-weight: 800;
    letter-spacing: -1px;
    color: var(--accent);
}

.heading-div p:last-child {
    color: var(--text-muted);
    font-size: 1.1rem;
}
  </style>
</head>

<body>
  
              <div class="heading-div">
       <p> BookBack </p>
       <p> Patients come back. Automatically.</p>
    </div>

  <div class="clinic-profile-div">
    <p class="clinic-name">Clinic</p>
    <p class="clinic-email">email</p>
  </div>

  <h2>Patients</h2>
  <button class="add-btn">Add Patient</button>

  <table class="patients-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Next Visit</th>
        <th>Reason</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody class="table-body">
      <!-- saved patients appear here -->
    </tbody>
  </table>
  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay">
    <div class="modal-box">
      <p>Are you sure you want to delete this patient?</p>

      <div class="modal-actions">
        <button class="cancel-btn">Cancel</button>
        <button class="confirm-btn">Delete</button>
      </div>
    </div>
  </div>


  <script>

    let pendingDeletePatientId = null;
    let pendingDeleteRow = null;

    //DOM Objects:- 
    let clinicNameP = document.querySelector(".clinic-name");
    let clinicEmailP = document.querySelector(".clinic-email");
    const API_BASE_URL = "https://bookback-t83d.onrender.com";
    document.addEventListener("DOMContentLoaded", async () => {
      let check = await fetch(`${API_BASE_URL}/refresh`,{
        method: "POST",
        credentials:"include"
      })
      if (!check.ok){
        window.location.href = "/index.html"
        return;
      }else{
        {}
      }


   
      let response = await fetch(`${API_BASE_URL}/refresh`, {
        method: "POST",
        credentials: "include"
      });
    

      if (!response.ok || response.status === 400) {
        alert("Oops ! Something went wrong !");
        window.location.href = "/index.html";
        return;
      };
      let data = await response.json();
      if (data.status === false){
        window.location.href = "/payment_page.html";
        return;
      }
      let fetchedPatientList = data.patient_list.data;

      renderPatientList(fetchedPatientList);

      let clinicName = data.username;
      let clinicEmail = data.email;

      clinicNameP.innerHTML = clinicName;
      clinicEmailP.innerHTML = clinicEmail;




    })
    let activeRow = null;

    document.querySelector(".add-btn").addEventListener("click", () => {
      if (activeRow) return;

      const tbody = document.querySelector(".table-body");
      const row = document.createElement("tr");
      row.classList.add("active-row");

      row.innerHTML = `
      <td><input type="text" placeholder="Name"></td>
      <td><input type="email" placeholder="Email"></td>
      <td><input type="text" placeholder="Phone"></td>
      <td><input type="date"></td>
      <td><input type="text" placeholder="Chief Complaint"></td>
      <td><button class="save-btn">Save</button></td>
    `;

      tbody.appendChild(row);
      activeRow = row;

      row.querySelector(".save-btn").addEventListener("click", async (e) => {
        e.stopPropagation();
        saveRow(row);

      });
    });

    async function saveRow(row) {
      const inputs = row.querySelectorAll("input");

      const values = [...inputs].map(input => input.value.trim());
      let patientDetails = {
        name: values[0],
        email: values[1],
        phone: values[2],
        next_visit: values[3],
        reason: values[4]
      }
      let response = await fetch(`${API_BASE_URL}/add-patient`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(patientDetails),
        credentials: "include"
      });

      let data = await response.json()





      if (values.some(v => v === "")) {
        alert("Fill all fields");
        return;
      }

      row.innerHTML = `
      <td>${values[0]}</td>
      <td>${values[1]}</td>
      <td>${values[2]}</td>
      <td>${values[3]}</td>
      <td>${values[4]}</td>
      <td><button class="delete-btn">Delete</button></td>
    `;

row.querySelector(".delete-btn").addEventListener("click", () => {
  pendingDeletePatientId = data.patient_id;   // returned from backend
  pendingDeleteRow = row;
  document.querySelector(".modal-overlay").style.display = "flex";
      });

      activeRow = null;
    }

    document.addEventListener("click", (e) => {
      if (!activeRow) return;

      if (!activeRow.contains(e.target) && !e.target.classList.contains("add-btn")) {
        activeRow.remove();
        activeRow = null;
      }
    });

    function renderPatientList(patientArray) {
      const tbody = document.querySelector(".table-body");

      patientArray.forEach((element) => {
        let row = document.createElement("tr");

        row.innerHTML = `
      <td>${element.name}</td>
      <td>${element.email}</td>
      <td>${element.phone}</td>
      <td>${element.next_visit}</td>
      <td>${element.reason}</td>
      <td><button class="delete-btn">Delete</button></td>
    `;

        row.querySelector(".delete-btn").addEventListener("click", () => {
          
          pendingDeletePatientId = element.id;
          pendingDeleteRow = row;
          document.querySelector(".modal-overlay").style.display = "flex";
        });


        tbody.appendChild(row);
      });
    }
    document.addEventListener("click", async (e) => {

      // Cancel delete
      if (e.target.classList.contains("cancel-btn")) {
        closeModal();
      }

      // Confirm delete
      if (e.target.classList.contains("confirm-btn")) {
        if (pendingDeletePatientId) {
          await delPatients(pendingDeletePatientId);
          pendingDeleteRow.remove();
        }
        closeModal();
      }
    });

    function closeModal() {
      document.querySelector(".modal-overlay").style.display = "none";
      pendingDeletePatientId = null;
      pendingDeleteRow = null;
    }







    async function delPatients(id) {
      let details = {
        patient_id: id
      }
      let response = await fetch(`${API_BASE_URL}/delete-patient`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(details)
      })

      let data = await response.json()
      
    }
  </script>

</body>

</html>